

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>fabfile.mongo &mdash; my Cloudmesh Learning documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/css/my_theme.css" type="text/css" />
  

  
        <link rel="author" title="About these documents"
              href="../../about.html"/>
    <link rel="top" title="my Cloudmesh Learning documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          <a href="../../index.html" class="icon icon-home"> my Cloudmesh
        

        
          
          <img src="../../_static/cm-logo-24.png" class="logo" />
        
        </a>

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../preface.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contact.html">Contact</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resources.html">Resources from the Internet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class/index.html">Cloudmesh in Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../projects/index.html">Possible Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../accounts/index.html">Cloud Accounts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloudmesh/index.html">Cloudmesh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parallel.html">Parallel Shell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../iaas/index.html">IaaS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../paas/index.html">PaaS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hpc/index.html">HPC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hardware/index.html">Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devops/index.html">DevOps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ipython/index.html">IPython</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rst.html">reStructuredText</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../management/index.html">Create Cloudmesh Development Image</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute/index.html">Contribute to Cloudmesh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../archived.html">Archived</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../todo.html">ToDos</a></li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">my Cloudmesh</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>fabfile.mongo</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for fabfile.mongo</h1><div class="highlight"><pre>
<span class="kn">from</span> <span class="nn">cloudmesh.shell.Shell</span> <span class="kn">import</span> <span class="n">Shell</span>
<span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">task</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">hide</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">from</span> <span class="nn">cloudmesh.cm_mongo</span> <span class="kn">import</span> <span class="n">cm_mongo</span>
<span class="kn">from</span> <span class="nn">cloudmesh.config.cm_config</span> <span class="kn">import</span> <span class="n">cm_config</span><span class="p">,</span> <span class="n">cm_config_server</span>
<span class="kn">from</span> <span class="nn">cloudmesh.user.cm_userLDAP</span> <span class="kn">import</span> <span class="n">cm_userLDAP</span>
<span class="kn">from</span> <span class="nn">cloudmesh.pbs.pbs_mongo</span> <span class="kn">import</span> <span class="n">pbs_mongo</span>
<span class="kn">from</span> <span class="nn">cloudmesh_base.util</span> <span class="kn">import</span> <span class="n">path_expand</span>
<span class="kn">from</span> <span class="nn">cloudmesh_base.util</span> <span class="kn">import</span> <span class="n">banner</span>
<span class="kn">from</span> <span class="nn">cloudmesh_base.util</span> <span class="kn">import</span> <span class="n">yn_choice</span>
<span class="kn">from</span> <span class="nn">cloudmesh.inventory</span> <span class="kn">import</span> <span class="n">Inventory</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">cloudmesh_common.util</span> <span class="kn">import</span> <span class="n">PROGRESS</span>
<span class="kn">import</span> <span class="nn">progress</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="n">PROGRESS</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;Cloudmesh Services&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">debug</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="n">cm_config_server</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;cloudmesh.server.debug&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
    <span class="n">progress</span><span class="o">.</span><span class="n">off</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">progress</span><span class="o">.</span><span class="n">on</span><span class="p">()</span>


<div class="viewcode-block" id="get_pid"><a class="viewcode-back" href="../../modules/cloudmesh/fabfile.html#fabfile.mongo.get_pid">[docs]</a><span class="k">def</span> <span class="nf">get_pid</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">hide</span><span class="p">(</span><span class="s">&#39;output&#39;</span><span class="p">,</span> <span class="s">&#39;running&#39;</span><span class="p">,</span> <span class="s">&#39;warnings&#39;</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">local</span><span class="p">(</span>
            <span class="s">&quot;ps -ax |fgrep {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">),</span> <span class="n">capture</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">line</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&quot;fgrep&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;No mongod running&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;SUCCESS: mongod PID&quot;</span><span class="p">,</span> <span class="n">pid</span>
    <span class="k">return</span> <span class="n">pid</span><span class="p">,</span> <span class="n">line</span>

</div>
<span class="nd">@task</span>
<div class="viewcode-block" id="reset"><a class="viewcode-back" href="../../modules/cloudmesh/fabfile.html#fabfile.mongo.reset">[docs]</a><span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">banner</span><span class="p">(</span><span class="s">&quot;initiating mongo&quot;</span><span class="p">)</span>
    <span class="n">boot</span><span class="p">()</span>
    <span class="n">banner</span><span class="p">(</span><span class="s">&quot;initiating user data to mongo&quot;</span><span class="p">)</span>
    <span class="n">PROGRESS</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="k">print</span>
    <span class="k">if</span> <span class="n">password</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">local</span><span class="p">(</span><span class="s">&quot;fab user.mongo&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">local</span><span class="p">(</span><span class="s">&quot;fab user.mongo:passwd={0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">password</span><span class="p">))</span>
    <span class="n">PROGRESS</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="n">banner</span><span class="p">(</span><span class="s">&quot;refreshing cloud info&quot;</span><span class="p">)</span>
    <span class="n">simple</span><span class="p">()</span>
    <span class="c"># local(&quot;reset&quot;)</span>

</div>
<span class="nd">@task</span>
<div class="viewcode-block" id="install_osx"><a class="viewcode-back" href="../../modules/cloudmesh/fabfile.html#fabfile.mongo.install_osx">[docs]</a><span class="k">def</span> <span class="nf">install_osx</span><span class="p">():</span>
    <span class="c"># local(&#39;ruby -e &quot;$(curl -fsSL https://raw.github.com/mxcl/homebrew/go)&quot;&#39;)</span>
    <span class="c"># local(&#39;brew update&#39;)</span>
    <span class="n">local</span><span class="p">(</span><span class="s">&#39;brew install mongodb&#39;</span><span class="p">)</span>

</div>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">@task</span>
<span class="sd">def install():</span>
<span class="sd">    &quot;&quot;&quot;installs mongo in ~/ENV/bin. Make sure your path is set correctly&quot;&quot;&quot;</span>
<span class="sd">    if sys.platform == &quot;darwin&quot;:</span>
<span class="sd">        os_version = &quot;osx&quot;</span>
<span class="sd">    elif sys.platform in [&quot;linux&quot;, &quot;linux2&quot;]:</span>
<span class="sd">        os_version = &quot;linux&quot;</span>
<span class="sd">    else:</span>
<span class="sd">        print &quot;ERROR: Wrong opertaing system: Found&quot;, sys.platform</span>
<span class="sd">        sys.exit()</span>

<span class="sd">    ENV = os.environ[&#39;VIRTUAL_ENV&#39;] + &quot;/bin&quot;</span>

<span class="sd">    if not ENV.endswith(&quot;ENV/bin&quot;):</span>
<span class="sd">        print &quot;WARNING: You are using a non standrad development &quot;\</span>
<span class="sd">            &quot;virtualenv location&quot;</span>
<span class="sd">        print &quot;         The standard location is&quot;, path_expand(&quot;~/ENV/bin&quot;)</span>
<span class="sd">        print &quot;         You use&quot;, ENV</span>
<span class="sd">        if not yn_choice(&quot;Would you like to proceed&quot;, default=&quot;n&quot;):</span>
<span class="sd">            sys.exit()</span>
<span class="sd">    else:</span>
<span class="sd">        print &quot;SUCCESS: You use the standard virtualenv setup&quot;</span>
<span class="sd">        print &quot;         The standard location is&quot;, path_expand(&quot;~/ENV/bin&quot;)</span>

<span class="sd">    mongo_version = &quot;mongodb-{0}-x86_64-2.4.6&quot;.format(os_version)</span>
<span class="sd">    mongo_tar = &quot;{0}.tgz&quot;.format(mongo_version)</span>
<span class="sd">    # for some reason with does not work</span>
<span class="sd">    # with cd(&#39;/tmp&#39;):</span>

<span class="sd">    if os.path.isfile(&quot;/tmp/{0}&quot;.format(mongo_tar)):</span>
<span class="sd">        print &quot;WRANING: mongo tar file already downloaded&quot;</span>
<span class="sd">        print &quot;         using&quot;, &quot;/tmp/{0}&quot;.format(mongo_tar)</span>
<span class="sd">    else:</span>
<span class="sd">        if sys.platform == &quot;darwin&quot;:</span>
<span class="sd">            local(</span>
<span class="sd">                &quot;cd /tmp; curl -O http://fastdl.mongodb.org/{1}/{0}.tgz&quot;</span>
<span class="sd">                .format(mongo_version, os_version))</span>
<span class="sd">        else:</span>
<span class="sd">            local(</span>
<span class="sd">                &quot;cd /tmp; wget http://fastdl.mongodb.org/{1}/{0}.tgz&quot;</span>
<span class="sd">                .format(mongo_version, os_version))</span>

<span class="sd">    local(&quot;cd /tmp; tar -xvf {0}.tgz&quot;.format(mongo_version))</span>
<span class="sd">    local(&quot;cd /tmp; cp {0}/bin/* {1}&quot;.format(mongo_version, ENV))</span>
<span class="sd">    where = local(&quot;which mongo&quot;, capture=True)</span>

<span class="sd">    if where.startswith(ENV):</span>
<span class="sd">        print &quot;SUCCESS. mongo commands are now installed in&quot;, ENV</span>
<span class="sd">    else:</span>
<span class="sd">        print &quot;ERROR: mongo is not in the path&quot;</span>
<span class="sd">        print &quot;       it should be in&quot;, ENV</span>
<span class="sd">        print &quot;       we found it in&quot;, where</span>

<span class="sd">    if is_ubuntu():</span>
<span class="sd">        install_packages([&quot;mongodb&quot;])</span>
<span class="sd">    elif is_centos():</span>
<span class="sd">        install_packages([&quot;mongodb&quot;,</span>
<span class="sd">                          &quot;mongodb-server&quot;])</span>
<span class="sd">    elif sys.platform == &quot;darwin&quot;:</span>
<span class="sd">        local(</span>
<span class="sd">            &#39;ruby -e &quot;$(curl -fsSL https://raw.github.com/mxcl/homebrew/go)&quot;&#39;)</span>
<span class="sd">        local(&#39;brew update&#39;)</span>
<span class="sd">        local(&#39;brew install mongodb&#39;)</span>
<span class="sd">&#39;&#39;&#39;</span>


<div class="viewcode-block" id="version"><a class="viewcode-back" href="../../modules/cloudmesh/fabfile.html#fabfile.mongo.version">[docs]</a><span class="k">def</span> <span class="nf">version</span><span class="p">():</span>
    <span class="n">ver</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s">&quot;mongod --version&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;version&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">ver</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="c"># print &quot;mongod service version is: &quot;, ver</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c"># print &quot;mongod serive not available&quot;</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">ver</span>

</div>
<span class="nd">@task</span>
<div class="viewcode-block" id="admin"><a class="viewcode-back" href="../../modules/cloudmesh/fabfile.html#fabfile.mongo.admin">[docs]</a><span class="k">def</span> <span class="nf">admin</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;creates a password protected user for mongo&quot;&quot;&quot;</span>

    <span class="n">banner</span><span class="p">(</span><span class="s">&quot;create auth user&quot;</span><span class="p">)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">cm_config_server</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;cloudmesh.server.mongo&quot;</span><span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&quot;username&quot;</span><span class="p">]</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&quot;password&quot;</span><span class="p">]</span>

    <span class="c">#</span>
    <span class="c"># setting up the list of dbs</span>
    <span class="c">#</span>
    <span class="n">dbs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="c"># print config[&quot;collections&quot;]</span>
    <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s">&quot;collections&quot;</span><span class="p">]:</span>
        <span class="n">dbs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;collections&#39;</span><span class="p">][</span><span class="n">collection</span><span class="p">][</span><span class="s">&#39;db&#39;</span><span class="p">])</span>

    <span class="c"># setting the admin user</span>
    <span class="n">script</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c"># script.append(&#39;db.addUser(&quot;{0}&quot;, &quot;{1}&quot;);&#39;.format(user, password))</span>
    <span class="c"># script.append(&#39;db.auth(&quot;{0}&quot;, &quot;{1}&quot;);&#39;.format(user, password))</span>

    <span class="n">mongoversion</span> <span class="o">=</span> <span class="n">version</span><span class="p">()</span>
    <span class="c"># setting a password for each db</span>
    <span class="k">for</span> <span class="n">db</span> <span class="ow">in</span> <span class="n">dbs</span><span class="p">:</span>
        <span class="n">script</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;db = db.getSiblingDB(&quot;{0}&quot;);&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
        <span class="c"># mongod has changes since v 2.6</span>
        <span class="c"># it uses createUser instead of addUser to add new user</span>
        <span class="c"># it does not create empty db if no records added</span>
        <span class="k">if</span> <span class="n">mongoversion</span> <span class="ow">and</span> <span class="n">mongoversion</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">script</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;db.createUser({&quot;user&quot;:&quot;</span><span class="si">%s</span><span class="s">&quot;, &quot;pwd&quot;:&quot;</span><span class="si">%s</span><span class="s">&quot;, &quot;roles&quot;:[&quot;dbOwner&quot;]})&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>
            <span class="n">script</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;use {0};&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
            <span class="c"># a trick to ensure the db is created</span>
            <span class="n">script</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;db.cmsysmeta.save({&quot;createdOn&quot;:&quot;</span><span class="si">%s</span><span class="s">&quot;})&#39;</span> <span class="o">%</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">script</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;db.addUser(&quot;{0}&quot;, &quot;{1}&quot;);&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>

    <span class="n">script</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;use admin;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mongoversion</span> <span class="ow">and</span> <span class="n">mongoversion</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">script</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;db.createUser({&quot;user&quot;:&quot;</span><span class="si">%s</span><span class="s">&quot;, &quot;pwd&quot;:&quot;</span><span class="si">%s</span><span class="s">&quot;, &quot;roles&quot;:[&quot;root&quot;]})&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">script</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;db.addUser(&quot;{0}&quot;, &quot;{1}&quot;);&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>

    <span class="c"># script.append(&#39;db.auth(&quot;{0}&quot;, &quot;{1}&quot;);&#39;.format(user, password))</span>
    <span class="c"># script.append(&#39;db.shutdownServer();&#39;)</span>

    <span class="n">mongo_script</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>

    <span class="c"># print mongo_script</span>
    <span class="n">command</span> <span class="o">=</span> <span class="s">&quot;echo &#39;{0}&#39; | mongo&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mongo_script</span><span class="p">)</span>
    <span class="c"># print command</span>
    <span class="n">banner</span><span class="p">(</span><span class="s">&quot;Executing js&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

</div>
<span class="nd">@task</span>
<div class="viewcode-block" id="wipe"><a class="viewcode-back" href="../../modules/cloudmesh/fabfile.html#fabfile.mongo.wipe">[docs]</a><span class="k">def</span> <span class="nf">wipe</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;wipes out all traces from mongo&quot;&quot;&quot;</span>
    <span class="n">kill</span><span class="p">()</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">cm_config_server</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;cloudmesh.server.mongo&quot;</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">path_expand</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">])</span>

    <span class="n">banner</span><span class="p">(</span><span class="s">&quot;{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="n">local</span><span class="p">(</span><span class="s">&quot;mkdir -p {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Shell</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="n">banner</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;-&quot;</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">result</span>
    <span class="k">print</span> <span class="mi">70</span> <span class="o">*</span> <span class="s">&quot;-&quot;</span>
    <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">yn_choice</span><span class="p">(</span><span class="s">&quot;deleting the directory&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&quot;n&quot;</span><span class="p">):</span>
            <span class="n">local</span><span class="p">(</span><span class="s">&quot;rm -rf {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="n">local</span><span class="p">(</span><span class="s">&quot;mkdir -p {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="n">banner</span><span class="p">(</span><span class="s">&quot;{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="n">local</span><span class="p">(</span><span class="s">&quot;ls {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="isyes"><a class="viewcode-back" href="../../modules/cloudmesh/fabfile.html#fabfile.mongo.isyes">[docs]</a><span class="k">def</span> <span class="nf">isyes</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="n">check</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">check</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;true&#39;</span><span class="p">,</span> <span class="s">&#39;false&#39;</span><span class="p">,</span> <span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="s">&#39;n&#39;</span><span class="p">,</span> <span class="s">&#39;yes&#39;</span><span class="p">,</span> <span class="s">&#39;no&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">check</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;true&#39;</span><span class="p">,</span> <span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="s">&#39;yes&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;parameter not in&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;true&#39;</span><span class="p">,</span> <span class="s">&#39;false&#39;</span><span class="p">,</span> <span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="s">&#39;n&#39;</span><span class="p">,</span> <span class="s">&#39;yes&#39;</span><span class="p">,</span> <span class="s">&#39;no&#39;</span><span class="p">]</span>
        <span class="k">print</span> <span class="s">&quot;found&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">check</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

</div>
<span class="nd">@task</span>
<div class="viewcode-block" id="boot"><a class="viewcode-back" href="../../modules/cloudmesh/fabfile.html#fabfile.mongo.boot">[docs]</a><span class="k">def</span> <span class="nf">boot</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="c"># wipe mongo</span>
    <span class="n">wipe</span><span class="p">()</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">PROGRESS</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="c"># start mongo without auth</span>
    <span class="n">start</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">PROGRESS</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">isyes</span><span class="p">(</span><span class="n">auth</span><span class="p">):</span>
        <span class="c"># create users</span>
        <span class="n">admin</span><span class="p">()</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">PROGRESS</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="c"># restart with auth</span>
        <span class="n">kill</span><span class="p">()</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">PROGRESS</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="n">start</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">auth</span><span class="p">)</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">PROGRESS</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">cm_config_server</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;cloudmesh.server.mongo&quot;</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">path_expand</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">])</span>
    <span class="n">banner</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">Shell</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">banner</span><span class="p">(</span><span class="s">&quot;PROCESS&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">local</span><span class="p">(</span><span class="s">&quot;ps -ax | fgrep mongo&quot;</span><span class="p">)</span>
    <span class="n">PROGRESS</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

</div>
<span class="nd">@task</span>
<div class="viewcode-block" id="start"><a class="viewcode-back" href="../../modules/cloudmesh/fabfile.html#fabfile.mongo.start">[docs]</a><span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    start the mongod service in the location as specified in</span>
<span class="sd">    cloudmesh_server.yaml</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">banner</span><span class="p">(</span><span class="s">&quot;Starting mongod&quot;</span><span class="p">)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">cm_config_server</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;cloudmesh.server.mongo&quot;</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">path_expand</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">])</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&quot;port&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;Creating mongodb directory in&quot;</span><span class="p">,</span> <span class="n">path</span>
        <span class="n">local</span><span class="p">(</span><span class="s">&quot;mkdir -p {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">hide</span><span class="p">(</span><span class="s">&#39;output&#39;</span><span class="p">,</span> <span class="s">&#39;running&#39;</span><span class="p">,</span> <span class="s">&#39;warnings&#39;</span><span class="p">):</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">local</span><span class="p">(</span>
                <span class="s">&quot;ps -ax |grep &#39;[m]ongod.*port {0}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="n">capture</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> \
                <span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lines</span> <span class="o">!=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]:</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">print</span> <span class="s">&quot;NO ACTION: mongo already running in pid {0} for port {1}&quot;</span> \
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;ACTION: Starting mongod&quot;</span>
        <span class="k">print</span>
        <span class="k">print</span> <span class="s">&quot;NOTE: the preparation of mongo may take a few minutes&quot;</span>
        <span class="k">print</span> <span class="s">&quot;      please do not interrupt this program.&quot;</span>
        <span class="k">print</span>
        <span class="k">print</span> <span class="s">&quot;      Please be patient!&quot;</span>
        <span class="k">print</span>

        <span class="n">with_auth</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">isyes</span><span class="p">(</span><span class="n">auth</span><span class="p">):</span>
            <span class="n">with_auth</span> <span class="o">=</span> <span class="s">&quot;--auth&quot;</span>

        <span class="n">local</span><span class="p">(</span>
            <span class="s">&#39;mongod {2} --bind_ip 127.0.0.1 &#39;</span>
            <span class="s">&#39;--fork --dbpath {0} &#39;</span>
            <span class="s">&#39;--logpath {0}/mongodb.log &#39;</span>
            <span class="s">&#39;--port {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">with_auth</span><span class="p">))</span>

</div>
<span class="nd">@task</span>
<div class="viewcode-block" id="clean"><a class="viewcode-back" href="../../modules/cloudmesh/fabfile.html#fabfile.mongo.clean">[docs]</a><span class="k">def</span> <span class="nf">clean</span><span class="p">():</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">cm_config_server</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;cloudmesh.server.mongo.port&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">local</span><span class="p">(</span>
        <span class="s">&#39;echo &quot;show dbs&quot; | mongo --quiet --port {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="n">capture</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">local</span><span class="p">(</span><span class="s">&#39;mongo {0} --port {1} --eval &quot;db.dropDatabase();&quot;&#39;</span>
              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>

</div>
<span class="nd">@task</span>
<div class="viewcode-block" id="inventory"><a class="viewcode-back" href="../../modules/cloudmesh/fabfile.html#fabfile.mongo.inventory">[docs]</a><span class="k">def</span> <span class="nf">inventory</span><span class="p">():</span>
    <span class="n">mesh_inventory</span> <span class="o">=</span> <span class="n">Inventory</span><span class="p">()</span>
    <span class="n">mesh_inventory</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">mesh_inventory</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
    <span class="n">mesh_inventory</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>

</div>
<span class="nd">@task</span>
<div class="viewcode-block" id="info"><a class="viewcode-back" href="../../modules/cloudmesh/fabfile.html#fabfile.mongo.info">[docs]</a><span class="k">def</span> <span class="nf">info</span><span class="p">():</span>
    <span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_pid</span><span class="p">(</span><span class="s">&quot;mongod&quot;</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">line</span>

</div>
<span class="nd">@task</span>
<div class="viewcode-block" id="kill"><a class="viewcode-back" href="../../modules/cloudmesh/fabfile.html#fabfile.mongo.kill">[docs]</a><span class="k">def</span> <span class="nf">kill</span><span class="p">():</span>
    <span class="n">stop</span><span class="p">()</span>

</div>
<span class="nd">@task</span>
<div class="viewcode-block" id="stop"><a class="viewcode-back" href="../../modules/cloudmesh/fabfile.html#fabfile.mongo.stop">[docs]</a><span class="k">def</span> <span class="nf">stop</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    stops the currently running mongod</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># for some reason shutdown does not work</span>
    <span class="c"># local(&quot;mongod --shutdown&quot;)</span>
    <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">hide</span><span class="p">(</span><span class="s">&#39;output&#39;</span><span class="p">,</span> <span class="s">&#39;running&#39;</span><span class="p">,</span> <span class="s">&#39;warnings&#39;</span><span class="p">):</span>
            <span class="n">local</span><span class="p">(</span><span class="s">&quot;killall -15 mongod&quot;</span><span class="p">)</span>

    <span class="c"># Added to make sure the mongodb server is shutdown.</span>
    <span class="c"># - killall does not work if the server is running on root or mongodb</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># this throw error messages in some cases</span>
        <span class="c"># local(&quot;echo \&quot;use admin\ndb.shutdownServer()\&quot; | mongo&quot;)</span>
        <span class="c"># this ignore the error message in case it occurs</span>
        <span class="c"># BUG: True</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s">&#39;echo &quot;use admin</span><span class="se">\n</span><span class="s">db.shutdownServer()&quot; | mongo&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="n">TRUE</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

        <span class="c"># (pid, line) = get_pid(&quot;mongod&quot;)</span>
        <span class="c"># if pid is None:</span>
        <span class="c"># print &quot;No mongod running&quot;</span>
        <span class="c"># else:</span>
        <span class="c"># print &quot;Kill mongod&quot;</span>
        <span class="c"># local (&quot;killall -15 mongod&quot;)</span>

</div>
<span class="nd">@task</span>
<div class="viewcode-block" id="vms_find"><a class="viewcode-back" href="../../modules/cloudmesh/fabfile.html#fabfile.mongo.vms_find">[docs]</a><span class="k">def</span> <span class="nf">vms_find</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">cm_config</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;cloudmesh.hpc.username&quot;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">cm_mongo</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">pprint</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">servers</span><span class="p">())</span>

</div>
<div class="viewcode-block" id="refresh"><a class="viewcode-back" href="../../modules/cloudmesh/fabfile.html#fabfile.mongo.refresh">[docs]</a><span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="n">types</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">cm_config</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;cloudmesh.hpc.username&quot;</span><span class="p">)</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">cm_mongo</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="n">types</span><span class="p">)</span>

</div>
<span class="nd">@task</span>
<div class="viewcode-block" id="cloud"><a class="viewcode-back" href="../../modules/cloudmesh/fabfile.html#fabfile.mongo.cloud">[docs]</a><span class="k">def</span> <span class="nf">cloud</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    puts a snapshot of users, servers, images, and flavors into mongo</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">refresh</span><span class="p">(</span><span class="n">types</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;users&#39;</span><span class="p">,</span> <span class="s">&#39;servers&#39;</span><span class="p">,</span> <span class="s">&#39;images&#39;</span><span class="p">,</span> <span class="s">&#39;flavors&#39;</span><span class="p">])</span>
    <span class="n">ldap</span><span class="p">()</span>
    <span class="n">inventory</span><span class="p">()</span>

</div>
<span class="nd">@task</span>
<div class="viewcode-block" id="simple"><a class="viewcode-back" href="../../modules/cloudmesh/fabfile.html#fabfile.mongo.simple">[docs]</a><span class="k">def</span> <span class="nf">simple</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    puts a snapshot of servers, images, and flavors into mongo (no users)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">refresh</span><span class="p">(</span><span class="n">types</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;servers&#39;</span><span class="p">,</span> <span class="s">&#39;images&#39;</span><span class="p">,</span> <span class="s">&#39;flavors&#39;</span><span class="p">])</span>
    <span class="n">PROGRESS</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="k">print</span>
    <span class="n">inventory</span><span class="p">()</span>
    <span class="n">PROGRESS</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="k">print</span>

</div>
<span class="nd">@task</span>
<div class="viewcode-block" id="users"><a class="viewcode-back" href="../../modules/cloudmesh/fabfile.html#fabfile.mongo.users">[docs]</a><span class="k">def</span> <span class="nf">users</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    puts a snapshot of the users into mongo</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">refresh</span><span class="p">(</span><span class="n">types</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;users&#39;</span><span class="p">])</span>

</div>
<span class="nd">@task</span>
<div class="viewcode-block" id="errormetric"><a class="viewcode-back" href="../../modules/cloudmesh/fabfile.html#fabfile.mongo.errormetric">[docs]</a><span class="k">def</span> <span class="nf">errormetric</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;puts an example of a log file into the mongodb logfile&quot;&quot;&quot;</span>
    <span class="c"># create the mongo object</span>
    <span class="c"># parse the log file</span>
    <span class="c"># put each error form the sql databse in toit</span>

</div>
<span class="nd">@task</span>
<div class="viewcode-block" id="ldap"><a class="viewcode-back" href="../../modules/cloudmesh/fabfile.html#fabfile.mongo.ldap">[docs]</a><span class="k">def</span> <span class="nf">ldap</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    fetches a user list from ldap and displays it</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">idp</span> <span class="o">=</span> <span class="n">cm_userLDAP</span><span class="p">()</span>
    <span class="n">idp</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;fg-ldap&quot;</span><span class="p">,</span> <span class="s">&quot;ldap&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">username</span><span class="p">:</span>
        <span class="n">idp</span><span class="o">.</span><span class="n">refresh_one</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">idp</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
    <span class="n">_users</span> <span class="o">=</span> <span class="n">idp</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>

    <span class="k">print</span> <span class="n">_users</span>
    <span class="k">print</span> <span class="p">(</span><span class="s">&quot;Fetching {0} Users from LDAP&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_users</span><span class="p">)))</span>


<span class="c"># @task</span>
<span class="c"># def fg():</span>
<span class="c"># &quot;&quot;&quot;create a simple testbed&quot;&quot;&quot;</span>
<span class="c"># start()</span>
<span class="c"># local(&quot;python cloudmesh_web/fg.py&quot;)</span>

</div>
<span class="nd">@task</span>
<div class="viewcode-block" id="projects"><a class="viewcode-back" href="../../modules/cloudmesh/fabfile.html#fabfile.mongo.projects">[docs]</a><span class="k">def</span> <span class="nf">projects</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">&quot;NOT IMPLEMENTED YET&quot;</span>
    <span class="k">print</span> <span class="s">&quot;this class will when finished be able to import project titles&quot;</span> \
          <span class="s">&quot; and description from the fg portal&quot;</span>

</div>
<span class="nd">@task</span>
<div class="viewcode-block" id="pbs"><a class="viewcode-back" href="../../modules/cloudmesh/fabfile.html#fabfile.mongo.pbs">[docs]</a><span class="k">def</span> <span class="nf">pbs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">kind</span><span class="p">):</span>
    <span class="n">_pbs</span> <span class="o">=</span> <span class="n">pbs_mongo</span><span class="p">()</span>

    <span class="c"># get hpc user</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">cm_config</span><span class="p">()</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;cloudmesh.hpc.username&quot;</span><span class="p">)</span>

    <span class="n">_pbs</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>

    <span class="k">print</span> <span class="s">&quot;ACTIVE PBS HOSTS&quot;</span><span class="p">,</span> <span class="n">_pbs</span><span class="o">.</span><span class="n">hosts</span>

    <span class="k">if</span> <span class="n">host</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">hosts</span> <span class="o">=</span> <span class="n">_pbs</span><span class="o">.</span><span class="n">hosts</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hosts</span> <span class="o">=</span> <span class="p">[</span><span class="n">host</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">kind</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;qstat&#39;</span><span class="p">,</span> <span class="s">&#39;nodes&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="n">kind</span><span class="p">]</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">hosts</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">kind</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;qstat&quot;</span><span class="p">,</span> <span class="s">&quot;queue&quot;</span><span class="p">,</span> <span class="s">&quot;q&quot;</span><span class="p">]:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">_pbs</span><span class="o">.</span><span class="n">get_pbsnodes</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;nodes&quot;</span><span class="p">]:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">_pbs</span><span class="o">.</span><span class="n">refresh_pbsnodes</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;PBS --&gt;&quot;</span>
        <span class="n">pprint</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="c"># Temporary cure for missing a shell prompt</span></div>
<span class="k">if</span> <span class="p">(</span><span class="n">PROGRESS</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">PROGRESS</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013, myCloudmesh.org/learning.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'Learning',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>